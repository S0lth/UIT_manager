@model Alarm

@{
    var alarm = (UITManagerWebServer.Models.Alarm)ViewData["Alarm"];
    ViewData["Title"] = "Alarm Details";
}

<div class="container-fluid py-3" style="max-width: 1700px;">
    <div class="row">
        <div class="col-12 mb-2">
            <h1 class="h2 fw-bold">Machine's Alarm Details</h1>
        </div>

        <div class="d-flex m-1 p-0 gap-2">
            <div class="col-md-6 mb-2">
                @Html.Partial("_AlarmInformations", ViewData["Alarm"])
            </div>

            <div class="col-md-6 mb-2">
                @Html.Partial("_Notes", ViewData["Notes"])
            </div>
        </div>
        <div class="d-flex m-1 p-0 gap-2">
            <div class="col-md-6 mb-2">
                @Html.Partial("_MachineInformations", ViewData["Alarm"])
            </div>
        </div>
    </div>
    <div class="row mt-5">
        <div class="col-12">
            <div class="d-flex justify-content-end gap-3">
                @{
                    var previousUrl = TempData["PreviousUrl"]?.ToString();
                    string previousPageName = "Previous Page";

                    if (!string.IsNullOrEmpty(previousUrl))
                    {
                        var uri = new Uri(previousUrl);
                        var path = uri.AbsolutePath;

                        if (string.IsNullOrEmpty(path) || path == "/")
                        {
                            previousPageName = "Home";
                        }
                        else
                        {
                            var segments = path.Split('/');

                            if (segments.Length >= 3)
                            {
                                previousPageName = string.Join(" ", segments[1], segments[2]).Replace("-", " ");
                            }
                            else if (segments.Length == 2)
                            {
                                previousPageName = segments[1].Replace("-", " ");
                            }
                            else
                            {
                                previousPageName = segments.LastOrDefault()?.Replace("-", " ") ?? "Previous Page";
                            }
                        }
                    }
                }

                @if (previousUrl != null)
                {
                    <a class="btn btn-outline-secondary" href="@previousUrl">
                        Back to @previousPageName
                    </a>
                }
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#alarmHistoryModal">
                    Alarm status history
                </button>

                <a class="btn btn-outline-primary" asp-action="Index" asp-controller="Alarms">
                    View all alarms
                </a>
                <a class="btn btn-outline-primary" asp-controller="Machine" asp-action="Details"
                   asp-route-id="@alarm.Machine.Id">
                    See machine details
                </a>
            </div>
        </div>
    </div>
    @Html.Partial("_AlarmStatusHistoryModal", ViewData["Alarm"])
</div>
<script>
    function updateAlarmStatus(alarmId, status) {
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
        if (!token) {
            alert('CSRF token is missing.');
            return;
        }
        fetch(`/AlarmDetail/UpdateStatus`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': token
            },
            body: JSON.stringify({id: alarmId, status: status})
        }).then(response => {
            if (!response.ok) {
                alert('Error updating status.');
            }
        }).catch(error => {
            alert('Network error updating status.');
        });
    }

    async function updateAlarmAttribution(alarmId, userId) {
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

        if (!token) {
            alert('CSRF token is missing.');
            return;
        }

        if (!alarmId || !userId) {
            alert('Invalid alarm or user ID.');
            return;
        }
        try {
            const response = await fetch('/AlarmDetail/Attribution', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': token
                },
                body: JSON.stringify({
                    id: alarmId,
                    userId: userId
                })
            });
            if (response.ok) {
                const result = await response.json();
            } else {
                alert('Error: Failed to update attribution. Status code: ' + response.status);
            }
        } catch (error) {
            console.error('Network or server error:', error);
            alert('An error occurred while updating the attribution.');
        }
    }
</script>
