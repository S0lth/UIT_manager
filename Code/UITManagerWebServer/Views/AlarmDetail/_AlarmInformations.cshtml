@model UITManagerWebServer.Models.Alarm
@{
    var userIsAuthorized = User.IsInRole("ITDirector") || User.IsInRole("MaintenanceManager");
    var currentStatus = Model?.GetLatestAlarmHistory()?.StatusType?.Name ?? "N/A";
}

@functions {

    string GetSeveryticolor(string currentSeverity)
    {
        return currentSeverity switch
        {
            "Critical" => "text-danger",
            "High" => "text-High",
            "Medium" => "text-warning",
            "Low" => "text-low",
            "Warning" => "text-secondary",
            _ => "text-secondary",
        };
    }

}

<div class="card shadow-sm border-0 rounded mb-4 p-4 bg-light">
    <h5 class="fw-bold">Alarm Information</h5>
    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm border-0 rounded h-100">
                <div class="card-header fw-bold d-flex align-items-center" style="height: 60px;">
                    Machine Concerned
                </div>
                <div class="card-body">
                    <p>@Model.Machine.Name</p>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0 rounded h-100">
                <div class="card-header fw-bold d-flex align-items-center" style="height: 60px;">
                    Alarm Concerned
                </div>
                <div class="card-body">
                    <p>@Model.NormGroup.Name</p>
                    <p class="@GetSeveryticolor(@Model.NormGroup?.SeverityHistories.OrderByDescending(sh => sh.UpdateDate).FirstOrDefault()?.Severity?.Name)">
                        @Model.NormGroup?.SeverityHistories.OrderByDescending(sh => sh.UpdateDate).FirstOrDefault()?.Severity?.Name
                    </p>
                    <p><strong>Triggered At:</strong> <br> @Model.TriggeredAt.ToString("dd-MM-yyyy HH:mm")</p>
                    <label for="AlarmStatus"><strong>Status</strong></label>
                    @if (userIsAuthorized)
                    {
                        <select id="AlarmStatus" name="AlarmStatus" style="max-width: 300px"
                                class="form-select form-select-sm"
                                onchange="updateAlarmStatus(@Model.Id, this.value)">
                            @foreach (var status in ViewData["AlarmStatusTypes"] as List<UITManagerWebServer.Models.AlarmStatusType>)
                            {
                                if (Model?.GetLatestAlarmHistory()?.StatusType?.Id != null && status.Id == Model.GetLatestAlarmHistory().StatusType.Id)
                                {
                                    <option selected value="@status.Name">
                                        @status.Name
                                    </option>
                                }
                                else
                                {
                                    <option value="@status.Name">
                                        @status.Name
                                    </option>
                                }

                                <option disabled class="text-secondary fst-italic fw-light"
                                        label="">@status.Description
                                </option>
                            }
                        </select>
                    }
                    else
                    {
                        <p class="fw-bold text-muted">@currentStatus</p>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0 rounded h-100">
                <div class="card-header fw-bold d-flex align-items-center" style="height: 60px;">
                    Informations
                    <button type="button" class="btn btn-link ms-2" data-bs-toggle="modal"
                            data-bs-target="#infoModal">
                        <i class="bi bi-info-circle"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column">
                        <div class="d-flex flex-column">
                            <p class="mb-0 fw-bold">Concerned Alarm</p>
                            <div class="text-muted mt-1">
                                @Model.NormGroup.Name
                            </div>
                        </div>

                        <div class="d-flex align-items-center mt-3">
                            <p class="mb-0 fw-bold">Total Occurrences</p>
                            <div class="badge bg-primary badge-sm ms-2">
                                @ViewData["AlarmCountAll"]
                            </div>
                        </div>

                        <div class="d-flex align-items-center mt-2">
                            <p class="mb-0 fw-bold">Machine Occurrences</p>
                            <div class="badge bg-primary badge-sm ms-2">
                                @ViewData["AlarmCount"]
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="infoModalLabel">Information</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Machine Occurences: alarms of the same type triggered on this machine.</p>
                            <p>Total Occurences: alarms of the same type triggered on this all machines.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
